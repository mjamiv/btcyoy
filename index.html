<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Historical Price Tracker - BBS Terminal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ========================================
           BBS/ASCII TERMINAL THEME
           ======================================== */

        /* CSS Custom Properties */
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0d1117;
            --bg-card: #161b22;
            --text-primary: #00ff00;
            --text-secondary: #33ff33;
            --text-dim: #6e7681;
            --text-white: #e6e6e6;
            --text-amber: #ffb000;
            --text-cyan: #00ffff;
            --btc-orange: #f7931a;
            --positive: #00ff00;
            --negative: #ff3333;
            --border-color: #30363d;
            --border-active: #00ff00;
            --font-mono: 'IBM Plex Mono', 'Courier New', monospace;
        }

        /* Global styles for terminal look */
        * {
            font-family: var(--font-mono);
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-mono);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Optional CRT Scanline Effect */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            z-index: 9999;
            opacity: 0.2;
        }

        /* Utility Classes */
        .text-cyan { color: var(--text-cyan); }
        .text-amber { color: var(--text-amber); }
        .text-dim { color: var(--text-dim); }
        .positive { color: var(--positive); }
        .negative { color: var(--negative); }

        /* Terminal Card Component */
        .terminal-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* ASCII Logo */
        .ascii-logo {
            white-space: pre;
            font-size: 0.625rem;
            line-height: 1.2;
            color: var(--btc-orange);
            margin-bottom: 1rem;
            font-weight: 400;
        }

        /* Terminal Header */
        .terminal-header {
            text-align: center;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .terminal-header h1 {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: normal;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .terminal-header .subtitle {
            color: var(--text-dim);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .terminal-header .date {
            color: var(--text-amber);
            font-size: 1.125rem;
            margin-top: 1rem;
        }

        /* Terminal Input Fields */
        input[type="date"],
        input[type="number"],
        input[type="text"] {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-family: var(--font-mono);
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
        }

        input:focus {
            outline: none;
            border-color: var(--border-active);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        /* Terminal Button */
        .terminal-btn {
            background-color: transparent;
            border: 1px solid var(--btc-orange);
            color: var(--btc-orange);
            font-family: var(--font-mono);
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.15s ease;
            font-weight: 500;
        }

        .terminal-btn:hover {
            background-color: var(--btc-orange);
            color: var(--bg-primary);
            box-shadow: 0 0 15px rgba(247, 147, 26, 0.5);
        }

        .terminal-btn:active {
            transform: translateY(1px);
        }

        /* Blockchain Blocks Overlay */
        .blocks-overlay {
            width: 100%;
            margin-bottom: 1rem;
            position: relative;
            min-height: 150px;
            overflow-x: auto;
            overflow-y: visible;
        }

        /* Aligned Block Cards - ANSI Style */
        .aligned-block {
            font-family: var(--font-mono);
            display: inline-block;
            vertical-align: top;
            transition: all 0.2s ease;
            white-space: pre;
            line-height: 1;
            font-size: 0.5rem;
            color: var(--text-primary);
        }

        .aligned-block:hover {
            filter: brightness(1.2);
        }

        /* Current Year Block */
        .aligned-block.current-year {
            color: var(--btc-orange);
            animation: terminal-pulse 2s ease-in-out infinite;
        }

        @keyframes terminal-pulse {
            0%, 100% {
                filter: brightness(1);
            }
            50% {
                filter: brightness(1.3);
            }
        }

        /* ANSI Block Elements */
        .ansi-block-date {
            color: var(--text-amber);
        }

        .ansi-block-price {
            color: var(--text-white);
        }

        .ansi-block-change-positive {
            color: var(--positive);
        }

        .ansi-block-change-negative {
            color: var(--negative);
        }

        .ansi-block-connector {
            color: var(--border-color);
        }

        /* Live Indicator */
        .live-indicator {
            color: var(--negative);
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Responsive Block Sizing */
        @media (max-width: 1024px) {
            .aligned-block {
                font-size: 0.45rem;
            }
        }

        @media (max-width: 768px) {
            .aligned-block {
                font-size: 0.4rem;
            }
        }

        @media (max-width: 640px) {
            .aligned-block {
                font-size: 0.35rem;
            }
        }

        /* Terminal Table */
        .terminal-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-mono);
        }

        .terminal-table thead {
            border-bottom: 1px solid var(--border-color);
        }

        .terminal-table th {
            color: var(--text-cyan);
            font-weight: normal;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.5rem 1rem;
            text-align: left;
        }

        .terminal-table td {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid rgba(48, 54, 61, 0.5);
        }

        .terminal-table tbody tr:hover {
            background-color: rgba(0, 255, 0, 0.05);
        }

        .terminal-table tbody tr.current-row {
            background-color: rgba(247, 147, 26, 0.1);
            border-color: var(--btc-orange);
        }

        /* Terminal Footer */
        .terminal-footer {
            text-align: center;
            padding: 2rem 0;
            border-top: 1px solid var(--border-color);
            margin-top: 2rem;
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .terminal-footer .divider {
            color: var(--border-color);
            margin-bottom: 1rem;
        }

        /* Section Headers */
        .section-header {
            color: var(--text-cyan);
            font-size: 1rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Scale Toggle */
        .scale-toggle {
            display: inline-flex;
            gap: 0;
            border: 1px solid var(--border-color);
        }

        .scale-toggle button {
            background-color: transparent;
            border: none;
            color: var(--text-dim);
            font-family: var(--font-mono);
            padding: 0.375rem 0.75rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.15s ease;
            font-size: 0.75rem;
            border-right: 1px solid var(--border-color);
        }

        .scale-toggle button:last-child {
            border-right: none;
        }

        .scale-toggle button:hover {
            background-color: rgba(0, 255, 0, 0.05);
            color: var(--text-primary);
        }

        .scale-toggle button.active {
            background-color: var(--border-active);
            color: var(--bg-primary);
            font-weight: bold;
        }

        /* Tailwind Overrides for Terminal Theme */
        .text-white { color: var(--text-white) !important; }
        .text-gray-400 { color: var(--text-dim) !important; }
        .text-gray-500 { color: var(--text-dim) !important; }
        .text-xl { font-size: 1.25rem !important; }
        .text-lg { font-size: 1.125rem !important; }
        .text-4xl { font-size: 1.5rem !important; }
        .mb-10 { margin-bottom: 2rem !important; }
        .mb-8 { margin-bottom: 1.5rem !important; }
        .mb-4 { margin-bottom: 1rem !important; }
        .mb-2 { margin-bottom: 0.5rem !important; }
        .mt-2 { margin-top: 0.5rem !important; }
        .gap-3 { gap: 0.75rem !important; }
        .gap-2 { gap: 0.5rem !important; }
        .p-6 { padding: 1.5rem !important; }
        .p-4 { padding: 1rem !important; }
        .px-4 { padding-left: 1rem !important; padding-right: 1rem !important; }
        .py-3 { padding-top: 0.75rem !important; padding-bottom: 0.75rem !important; }
        .py-8 { padding-top: 2rem !important; padding-bottom: 2rem !important; }
        .rounded-xl { border-radius: 0 !important; }
        .rounded-lg { border-radius: 0 !important; }
        .rounded { border-radius: 0 !important; }
        .hidden { display: none !important; }
        .flex { display: flex !important; }
        .grid { display: grid !important; }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="terminal-header">
            <!-- ASCII Bitcoin Logo -->
            <pre class="ascii-logo">
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│     ██████╗ ██╗████████╗ ██████╗ ██████╗ ██╗███╗   ██╗                 │
│     ██╔══██╗██║╚══██╔══╝██╔════╝██╔═══██╗██║████╗  ██║                 │
│     ██████╔╝██║   ██║   ██║     ██║   ██║██║██╔██╗ ██║                 │
│     ██╔══██╗██║   ██║   ██║     ██║   ██║██║██║╚██╗██║                 │
│     ██████╔╝██║   ██║   ╚██████╗╚██████╔╝██║██║ ╚████║                 │
│     ╚═════╝ ╚═╝   ╚═╝    ╚═════╝ ╚═════╝ ╚═╝╚═╝  ╚═══╝                 │
│                                                                        │
│                   ████████╗██╗███╗   ███╗███████╗                      │
│                   ╚══██╔══╝██║████╗ ████║██╔════╝                      │
│                      ██║   ██║██╔████╔██║█████╗                        │
│                      ██║   ██║██║╚██╔╝██║██╔══╝                        │
│                      ██║   ██║██║ ╚═╝ ██║███████╗                      │
│                      ╚═╝   ╚═╝╚═╝     ╚═╝╚══════╝                      │
│                                                                        │
│              ███╗   ███╗ █████╗  ██████╗██╗  ██╗██╗███╗   ██╗███████╗  │
│              ████╗ ████║██╔══██╗██╔════╝██║  ██║██║████╗  ██║██╔════╝  │
│              ██╔████╔██║███████║██║     ███████║██║██╔██╗ ██║█████╗    │
│              ██║╚██╔╝██║██╔══██║██║     ██╔══██║██║██║╚██╗██║██╔══╝    │
│              ██║ ╚═╝ ██║██║  ██║╚██████╗██║  ██║██║██║ ╚████║███████╗  │
│              ╚═╝     ╚═╝╚═╝  ╚═╝ ╚═════╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝╚══════╝  │
│                                                                        │
│    ┌──────────────────────────────────────────────────────────────┐    │
│    │                 ₿  HISTORICAL PRICE TRACKER                  │    │
│    │     Explore Bitcoin Price on this day throughout history     │    │
│    └──────────────────────────────────────────────────────────────┘    │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
</pre>
        </header>

        <!-- Investment Calculator -->
        <section class="terminal-card">
            <div class="section-header">
                <span class="text-cyan">[CALC]</span> INVESTMENT CALCULATOR
            </div>
            <div class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-48">
                    <label class="block text-dim mb-2">> Purchase Date:</label>
                    <input type="date" id="purchaseDate" min="2010-07-18" max="">
                </div>
                <div class="flex-1 min-w-48">
                    <label class="block text-dim mb-2">> Investment (USD):</label>
                    <input type="number" id="investmentAmount" value="1000" min="1">
                </div>
                <button onclick="calculateReturns()" class="terminal-btn">
                    [ CALCULATE RETURNS ]
                </button>
            </div>

            <!-- Results Panel -->
            <div id="resultsPanel" class="hidden mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="terminal-card p-4 text-center">
                    <p class="text-dim text-sm mb-1">Purchase Price</p>
                    <p id="purchasePrice" class="text-2xl font-bold text-amber">-</p>
                    <p id="purchaseDateDisplay" class="text-dim text-xs mt-1"></p>
                </div>
                <div class="terminal-card p-4 text-center">
                    <p class="text-dim text-sm mb-1">Current Value</p>
                    <p id="currentValue" class="text-2xl font-bold positive">-</p>
                </div>
                <div class="terminal-card p-4 text-center">
                    <p class="text-dim text-sm mb-1">Total Return</p>
                    <p id="totalReturn" class="text-2xl font-bold">-</p>
                </div>
            </div>
        </section>

        <!-- Historical Data (Hidden until calculator submission) -->
        <div id="chartWithBlocksWrapper" class="hidden">
            <!-- Bitcoin Blockchain Blocks -->
            <section class="terminal-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="section-header" style="margin-bottom: 0;">
                        <span class="text-cyan">[BLOCK]</span> BITCOIN BLOCKCHAIN - <span id="timelineDate" class="text-amber"></span>
                    </div>
                    <div class="text-right">
                        <p class="text-dim text-xs">TODAY</p>
                        <div id="livePrice" class="text-2xl font-bold text-amber">Loading...</div>
                        <span class="live-indicator text-xs">[LIVE]</span>
                    </div>
                </div>
                <div id="blocksOverlay" class="blocks-overlay">
                    <!-- Blocks will be dynamically generated and positioned here -->
                </div>
                <p id="priceSource" class="text-dim text-xs text-center mt-2"></p>
            </section>

            <!-- Chart Section -->
            <section class="terminal-card">
                <div class="flex items-center justify-between mb-4">
                    <div class="section-header" style="margin-bottom: 0;">
                        <span class="text-cyan">[CHART]</span> PRICE ON THIS DAY EACH YEAR
                    </div>
                    <div class="scale-toggle">
                        <button id="logScaleBtn" class="active" onclick="setChartScale('logarithmic')">LOG</button>
                        <button id="linearScaleBtn" onclick="setChartScale('linear')">LINEAR</button>
                    </div>
                </div>
                <div class="relative h-80">
                    <canvas id="priceChart"></canvas>
                </div>
            </section>
        </div>
        <!-- End of chartWithBlocksWrapper -->

        <!-- Data Table -->
        <section id="tableSection" class="terminal-card hidden">
            <div class="section-header">
                <span class="text-cyan">[DATA]</span> HISTORICAL DATA FOR <span id="tableDateHeader" class="text-amber"></span>
            </div>
            <div class="overflow-x-auto">
                <table class="terminal-table w-full">
                    <thead>
                        <tr>
                            <th class="text-left">DATE</th>
                            <th class="text-right">BTC/USD</th>
                            <th class="text-right">RETURN</th>
                            <th class="text-right">5YR CAGR</th>
                            <th id="comparisonHeader" class="text-right hidden">VS PURCHASE</th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody">
                        <tr><td colspan="5" class="text-center py-8 text-dim">[ Loading data... ]</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Footer -->
        <footer class="terminal-footer">
            <pre class="divider">═══════════════════════════════════════════════════════════════════</pre>
            <p>[ Data: Historical Bitcoin Price Data | CoinGecko API ]</p>
            <p class="mt-1">[ Genesis Block: January 3, 2009</p>
            <p class="text-xs mt-2" style="opacity: 0.7;">(C) 2026 BTC Time Machine</p>
        </footer>
    </div>

    <script>
        // Sample historical data (fallback if CSV not available)
        // Format: MM/DD/YYYY for matching purposes
        const sampleHistoricalData = `Date,Price
01/03/2011,0.30
01/03/2012,5.27
01/03/2013,13.30
01/03/2014,770.44
01/03/2015,314.25
01/03/2016,430.01
01/03/2017,1021.75
01/03/2018,14764.20
01/03/2019,3843.52
01/03/2020,7344.88
01/03/2021,32782.02
01/03/2022,46458.12
01/03/2023,16625.08
01/03/2024,44172.22
01/03/2025,97500.00
11/23/2011,2.48
11/23/2012,11.99
11/23/2013,798.62
11/23/2014,367.13
11/23/2015,323.87
11/23/2016,740.36
11/23/2017,8112.24
11/23/2018,4346.75
11/23/2019,7178.25
11/23/2020,18353.27
11/23/2021,56287.46
11/23/2022,16589.23
11/23/2023,37420.89
11/23/2024,99588.00
11/23/2025,98827.00`;

        let historicalData = {};
        let todayData = [];
        let purchaseYearPrice = null;
        let chart = null;
        let currentPrice = null;
        let chartScaleType = 'logarithmic'; // Default to logarithmic scale

        // Get today's month and day
        const today = new Date();
        const todayMonth = today.getMonth() + 1;
        const todayDay = today.getDate();
        const todayYear = today.getFullYear();

        // Display current date
        const monthNames = ["January", "February", "March", "April", "May", "June",
                           "July", "August", "September", "October", "November", "December"];
        // Note: currentDate element was removed from HTML, so we skip setting it
        document.getElementById('tableDateHeader').textContent =
            `${monthNames[todayMonth - 1]} ${todayDay}`;
        document.getElementById('timelineDate').textContent =
            `${monthNames[todayMonth - 1]} ${todayDay}`;

        // Parse CSV data
        function parseCSV(csvText) {
            // Remove BOM if present
            csvText = csvText.replace(/^\uFEFF/, '');

            const lines = csvText.trim().split('\n');
            const data = {};

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Split CSV by comma, handling quoted fields
                // This regex splits on commas that are outside quotes
                const parts = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        parts.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                parts.push(current.trim());

                if (parts.length >= 2) {
                    // Get date and price (first two columns)
                    let dateStr = parts[0].replace(/"/g, '').trim();
                    let priceStr = parts[1].replace(/"/g, '').trim();

                    // Remove comma separators from price (e.g., "87,612.7" -> "87612.7")
                    priceStr = priceStr.replace(/,/g, '');
                    const price = parseFloat(priceStr);

                    if (!isNaN(price) && dateStr) {
                        data[dateStr] = price;
                    }
                }
            }

            console.log('Parsed dates count:', Object.keys(data).length);
            console.log('Sample dates:', Object.keys(data).slice(0, 5));
            return data;
        }

        // Filter data for today's date across all years
        function filterTodayData(data) {
            const result = [];
            const todayPattern = `${todayMonth.toString().padStart(2, '0')}/${todayDay.toString().padStart(2, '0')}`;
            
            for (const [dateStr, price] of Object.entries(data)) {
                // Parse MM/DD/YYYY format
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const month = parseInt(parts[0]);
                    const day = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    
                    if (month === todayMonth && day === todayDay) {
                        result.push({ date: dateStr, year: year, price: price });
                    }
                }
            }
            
            // Sort by year ascending
            result.sort((a, b) => a.year - b.year);
            return result;
        }

        // Calculate metrics
        function calculateMetrics(data) {
            if (data.length === 0) return data;
            
            const genesisPrice = data[0].price;
            
            return data.map((item, index) => {
                // Return since genesis
                const returnSinceGenesis = ((item.price - genesisPrice) / genesisPrice) * 100;
                
                // 5-Year CAGR
                let cagr5Year = null;
                if (index >= 5) {
                    const price5YearsAgo = data[index - 5].price;
                    cagr5Year = (Math.pow(item.price / price5YearsAgo, 1/5) - 1) * 100;
                }
                
                return {
                    ...item,
                    returnSinceGenesis,
                    cagr5Year
                };
            });
        }

        // Format currency
        function formatCurrency(value) {
            if (value === null || value === undefined) return '-';
            if (value >= 1) {
                return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return '$' + value.toFixed(4);
            }
        }

        // Format currency for table (whole numbers)
        function formatCurrencyTable(value) {
            if (value === null || value === undefined) return '-';
            return '$' + Math.round(value).toLocaleString('en-US');
        }

        // Format percentage
        function formatPercent(value, includeSign = true) {
            if (value === null || value === undefined) return '-';
            const sign = value >= 0 ? '+' : '';
            return (includeSign ? sign : '') + value.toFixed(2) + '%';
        }

        // Format percentage for table (whole numbers)
        function formatPercentTable(value, includeSign = true) {
            if (value === null || value === undefined) return '-';
            const sign = value >= 0 ? '+' : '';
            return (includeSign ? sign : '') + Math.round(value).toLocaleString('en-US') + '%';
        }

        // Populate year selector
        function populateYearSelector(data) {
            const select = document.getElementById('purchaseYear');
            select.innerHTML = '<option value="">Select a year...</option>';
            
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.year;
                option.textContent = item.year;
                select.appendChild(option);
            });
        }

        // Render table
        function renderTable(data, purchaseDate = null, purchasePrice = null) {
            const tbody = document.getElementById('priceTableBody');
            const comparisonHeader = document.getElementById('comparisonHeader');

            // Parse purchase date to get year for comparison
            let purchaseYear = null;
            if (purchaseDate) {
                const parts = purchaseDate.split('/');
                if (parts.length === 3) {
                    purchaseYear = parseInt(parts[2]);
                }
            }

            comparisonHeader.classList.toggle('hidden', !purchaseDate);

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-dim">[ No data available ]</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const returnClass = item.returnSinceGenesis >= 0 ? 'positive' : 'negative';
                const cagrClass = item.cagr5Year !== null && item.cagr5Year >= 0 ? 'positive' : 'negative';
                const isCurrentYear = item.year === todayYear;
                const rowClass = isCurrentYear ? 'current-row' : '';

                // ASCII live indicator instead of emoji
                const liveTag = isCurrentYear ? ' <span class="live-indicator">[LIVE]</span>' : '';

                let comparisonCell = '';
                if (purchaseDate && purchasePrice) {
                    // Show returns only for years on or after purchase year
                    if (item.year >= purchaseYear) {
                        const returnSincePurchase = ((item.price - purchasePrice) / purchasePrice) * 100;
                        const returnPurchaseClass = returnSincePurchase >= 0 ? 'positive' : 'negative';
                        comparisonCell = `<td class="text-right ${returnPurchaseClass}">${formatPercentTable(returnSincePurchase)}</td>`;
                    } else {
                        comparisonCell = `<td class="text-right text-dim">---</td>`;
                    }
                }

                return `
                    <tr class="${rowClass}">
                        <td>${monthNames[todayMonth - 1]} ${todayDay}, ${item.year}${liveTag}</td>
                        <td class="text-right text-amber">${formatCurrencyTable(item.price)}</td>
                        <td class="text-right ${returnClass}">${formatPercentTable(item.returnSinceGenesis)}</td>
                        <td class="text-right ${cagrClass}">${item.cagr5Year !== null ? formatPercentTable(item.cagr5Year) : '---'}</td>
                        ${comparisonCell}
                    </tr>
                `;
            }).reverse().join('');
        }

        // Render chart
        function renderChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const labels = data.map(d => d.year.toString());
            const prices = data.map(d => d.price);

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'BTC Price (USD)',
                        data: prices,
                        borderColor: '#f7931a',
                        backgroundColor: 'rgba(247, 147, 26, 0.05)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0,  // Angular lines for terminal aesthetic
                        pointBackgroundColor: '#f7931a',
                        pointBorderColor: '#0a0a0a',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointStyle: 'rect'  // Square points like terminal
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#161b22',
                            titleColor: '#00ffff',
                            bodyColor: '#00ff00',
                            borderColor: '#30363d',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            titleFont: {
                                family: "'IBM Plex Mono', monospace",
                                size: 12
                            },
                            bodyFont: {
                                family: "'IBM Plex Mono', monospace",
                                size: 14
                            },
                            callbacks: {
                                title: function(context) {
                                    return '[ ' + context[0].label + ' ]';
                                },
                                label: function(context) {
                                    return '> ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(48, 54, 61, 0.5)',
                                lineWidth: 1,
                                drawBorder: true,
                                borderColor: '#30363d',
                                borderDash: [2, 2]
                            },
                            ticks: {
                                color: '#6e7681',
                                font: {
                                    family: "'IBM Plex Mono', monospace",
                                    size: 11
                                }
                            }
                        },
                        y: {
                            type: chartScaleType,
                            grid: {
                                color: 'rgba(48, 54, 61, 0.5)',
                                lineWidth: 1,
                                drawBorder: true,
                                borderColor: '#30363d',
                                borderDash: [2, 2]
                            },
                            ticks: {
                                color: '#6e7681',
                                font: {
                                    family: "'IBM Plex Mono', monospace",
                                    size: 11
                                },
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return '$' + (value / 1000).toFixed(0) + 'k';
                                    }
                                    return '$' + value;
                                }
                            }
                        }
                    },
                    elements: {
                        line: {
                            borderCapStyle: 'square',
                            borderJoinStyle: 'miter'
                        }
                    }
                }
            });
        }

        // Set chart scale type (logarithmic or linear)
        function setChartScale(scaleType) {
            chartScaleType = scaleType;

            // Update button states
            document.getElementById('logScaleBtn').classList.toggle('active', scaleType === 'logarithmic');
            document.getElementById('linearScaleBtn').classList.toggle('active', scaleType === 'linear');

            // Re-render chart with new scale if data is available
            if (todayData && todayData.length > 0) {
                renderChart(todayData);
            }
        }

        // Generate a pseudo-hash based on year and price
        function generateBlockHash(year, price) {
            const hashInput = `${year}${price}`;
            let hash = '';
            for (let i = 0; i < 16; i++) {
                const charCode = hashInput.charCodeAt(i % hashInput.length);
                hash += ((charCode * (i + 1) * 997) % 16).toString(16);
            }
            return hash;
        }

        // Calculate approximate block height for a year
        function calculateBlockHeight(year) {
            // Bitcoin genesis block: Jan 3, 2009 (block 0)
            // Approximate blocks per year: 52,560 (6 blocks/hour * 24 * 365)
            const genesisYear = 2009;
            const blocksPerYear = 52560;
            const yearsSinceGenesis = year - genesisYear;
            return Math.floor(yearsSinceGenesis * blocksPerYear);
        }

        // Render timeline blocks aligned with chart - ANSI Style
        function renderTimelineCards(data) {
            const container = document.getElementById('blocksOverlay');
            if (!container) return;

            if (data.length === 0) {
                container.innerHTML = '<div class="aligned-block p-4 text-center"><p class="text-dim text-sm">[ NO DATA ]</p></div>';
                return;
            }

            const monthAbbr = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];

            // Render blocks in chronological order (matching chart x-axis)
            const blocks = data.map((item, index) => {
                const prevItem = index > 0 ? data[index - 1] : null;
                let changePercent = null;
                let changeClass = '';

                if (prevItem) {
                    changePercent = ((item.price - prevItem.price) / prevItem.price) * 100;
                    changeClass = changePercent >= 0 ? 'ansi-block-change-positive' : 'ansi-block-change-negative';
                }

                // Highlight current year
                const isCurrentYear = item.year === todayYear;
                const currentYearClass = isCurrentYear ? 'current-year' : '';

                // Format date as "MON. DD 'YY"
                const dateFormatted = `${monthAbbr[todayMonth - 1]}. ${todayDay.toString().padStart(2, '0')} '${item.year.toString().slice(-2)}`;
                const datePadded = dateFormatted.padEnd(15, ' ');

                // Format price
                const priceFormatted = `$ ${Math.round(item.price).toLocaleString('en-US')}`;
                const pricePadded = priceFormatted.padEnd(15, ' ');

                // Format change percentage
                const changeSign = changePercent === null ? '' : (changePercent >= 0 ? '+' : '-');
                const changeValue = changePercent === null ? '---' : `${changeSign}${Math.abs(changePercent).toFixed(2)}`;
                const changePadded = changeValue.padEnd(15, ' ');

                // Check if this is the last block (no connector)
                const isLastBlock = index === data.length - 1;
                const connectorLine5 = isLastBlock ? '' : ' ████╗';
                const connectorLine6 = isLastBlock ? '' : ' ╚═══╝';
                const spacer = isLastBlock ? '' : ' ';

                return `<div class="aligned-block ${currentYearClass}">███████████████████╗${spacer}
██               ██║${spacer}
██ <span class="ansi-block-date">${datePadded}</span>██║${spacer}
██               ██║${spacer}
██ <span class="ansi-block-price">${pricePadded}</span>██║${connectorLine5}
██               ██║${connectorLine6}
██ <span class="${changeClass}">${changePadded}</span>██║${spacer}
██               ██║${spacer}
███████████████████║${spacer}
╚══════════════════╝${spacer}</div>`;
            }).join('');

            container.innerHTML = blocks;
        }


        // Fetch current BTC price and add to todayData
        async function fetchCurrentPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                const data = await response.json();
                currentPrice = data.bitcoin.usd;
                document.getElementById('livePrice').textContent = formatCurrency(currentPrice);
                document.getElementById('priceSource').textContent = 'Live price from CoinGecko';

                // Add current year's price to todayData
                addCurrentYearToData();

                return currentPrice;
            } catch (error) {
                console.error('Failed to fetch current price:', error);
                document.getElementById('livePrice').textContent = 'Unable to fetch';
                document.getElementById('priceSource').textContent = 'API unavailable';
                return null;
            }
        }

        // Add current year's price to the dataset
        function addCurrentYearToData() {
            if (!currentPrice || !todayData) return;

            // Check if current year already exists in data
            const currentYearExists = todayData.some(item => item.year === todayYear);

            if (!currentYearExists) {
                // Add current year with live price
                const dateStr = `${todayMonth.toString().padStart(2, '0')}/${todayDay.toString().padStart(2, '0')}/${todayYear}`;
                todayData.push({
                    date: dateStr,
                    year: todayYear,
                    price: currentPrice
                });

                // Sort by year
                todayData.sort((a, b) => a.year - b.year);

                // Recalculate metrics
                todayData = calculateMetrics(todayData);
            }
        }

        // Calculate returns based on purchase date
        function calculateReturns() {
            const purchaseDateInput = document.getElementById('purchaseDate').value;
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value) || 1000;

            if (!purchaseDateInput) {
                alert('Please select a purchase date');
                return;
            }

            // Verify data is loaded
            if (Object.keys(historicalData).length === 0) {
                alert('Historical data is still loading. Please try again in a moment.');
                return;
            }

            // Convert YYYY-MM-DD to MM/DD/YYYY format for lookup
            const dateParts = purchaseDateInput.split('-');
            const year = dateParts[0];
            const month = dateParts[1].padStart(2, '0');
            const day = dateParts[2].padStart(2, '0');
            const purchaseDateStr = `${month}/${day}/${year}`;

            // Look up price for the specific date
            const purchasePrice = historicalData[purchaseDateStr];
            if (!purchasePrice) {
                console.log('Available dates:', Object.keys(historicalData).slice(0, 10));
                console.log('Looking for:', purchaseDateStr);
                alert(`No price data available for ${purchaseDateStr}.\n\nNote: Historical data may only be available for specific dates.\nTry selecting January 3rd or November 23rd of any year.`);
                return;
            }

            const latestData = todayData[todayData.length - 1];
            const latestPrice = currentPrice || latestData.price;

            const btcAmount = investmentAmount / purchasePrice;
            const currentValue = btcAmount * latestPrice;
            const totalReturn = ((currentValue - investmentAmount) / investmentAmount) * 100;

            // Display in new format: "On [date] I invested [$X] to purchase [Y] BTC"
            const resultsPanel = document.getElementById('resultsPanel');
            resultsPanel.innerHTML = `
                <div class="terminal-card p-6 text-center">
                    <p class="text-xl mb-4 leading-relaxed text-white">
                        > On <span class="text-amber font-bold">${purchaseDateStr}</span>
                        I invested <span class="text-amber font-bold">${formatCurrency(investmentAmount)}</span>
                        to purchase <span class="text-amber font-bold">${btcAmount.toFixed(8)} BTC</span>
                    </p>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <p class="text-dim text-sm">Current Value</p>
                            <p class="text-3xl font-bold positive">${formatCurrency(currentValue)}</p>
                        </div>
                        <div>
                            <p class="text-dim text-sm">Total Return</p>
                            <p class="text-3xl font-bold ${totalReturn >= 0 ? 'positive' : 'negative'}">
                                ${formatPercent(totalReturn)}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            resultsPanel.classList.remove('hidden');

            // CRITICAL: Show historical sections after calculator submission
            showHistoricalSections();

            // Render all views
            renderChart(todayData);
            renderTimelineCards(todayData);
            renderTable(todayData, purchaseDateStr, purchasePrice);
        }

        // Helper functions for showing/hiding historical sections
        function hideHistoricalSections() {
            const wrapper = document.getElementById('chartWithBlocksWrapper');
            const table = document.getElementById('tableSection');
            if (wrapper) wrapper.classList.add('hidden');
            if (table) table.classList.add('hidden');
        }

        function showHistoricalSections() {
            const wrapper = document.getElementById('chartWithBlocksWrapper');
            const table = document.getElementById('tableSection');
            if (wrapper) wrapper.classList.remove('hidden');
            if (table) table.classList.remove('hidden');
        }

        // Load data from CSV file or use sample data
        async function loadData(skipRender = false) {
            let csvText = null;

            // Try to load the CSV file - try multiple filenames
            // Note: URL-encode filenames with spaces for proper fetching
            const filenames = [
                'Bitcoin%20Historical%20Data_missing%20data.csv',
                'Bitcoin Historical Data_missing data.csv',
                'btc-historical-price.csv',
                'btc-historical-price'
            ];

            for (const filename of filenames) {
                try {
                    const response = await fetch(filename);
                    if (response.ok) {
                        csvText = await response.text();
                        console.log(`Successfully loaded: ${filename}`);
                        break;
                    }
                } catch (e) {
                    console.log(`Failed to load ${filename}`);
                }
            }
            
            // Use sample data if file not available
            if (!csvText) {
                csvText = sampleHistoricalData;
                console.log('Using sample historical data');
            }
            
            historicalData = parseCSV(csvText);
            console.log('Historical data entries:', Object.keys(historicalData).length);
            console.log('Sample lookup test - 12/17/2025:', historicalData['12/17/2025']);
            todayData = filterTodayData(historicalData);
            todayData = calculateMetrics(todayData);
            
            // If no data for today's date, generate sample data
            if (todayData.length === 0) {
                // Use all available data points for demonstration
                const allData = Object.entries(historicalData).map(([date, price]) => {
                    const parts = date.split('/');
                    return { date, year: parseInt(parts[2]), price };
                }).sort((a, b) => a.year - b.year);
                
                // Get unique years
                const uniqueYears = [...new Set(allData.map(d => d.year))];
                todayData = uniqueYears.map(year => {
                    const yearData = allData.find(d => d.year === year);
                    return yearData || null;
                }).filter(Boolean);
                
                todayData = calculateMetrics(todayData);
            }

            // Only render if not skipped (for initial page load, we skip rendering)
            if (!skipRender) {
                renderTimelineCards(todayData);
                renderTable(todayData);
                renderChart(todayData);
            }
        }

        // Initialize
        async function init() {
            // 1. Hide historical sections initially (calculator is landing page)
            hideHistoricalSections();

            // 2. Set max date for purchase date input to today
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('purchaseDate').setAttribute('max', todayStr);

            // 3. Load data in background (skip rendering)
            await loadData(true);

            // 4. Fetch live price in background
            await fetchCurrentPrice();
        }

        init();
    </script>
</body>
</html>
