<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Historical Price Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        .gold-text {
            color: #f7931a;
        }
        .btc-gradient {
            background: linear-gradient(135deg, #f7931a 0%, #ffab40 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }

        /* Grid-based blocks overlay for chart alignment */
        .blocks-overlay {
            display: grid;
            width: 100%;
            margin-bottom: 1rem;
            position: relative;
            min-height: 100px;
            gap: 4px;
        }

        /* Aligned block styling */
        .aligned-block {
            min-width: 0;
            max-width: 120px;
            width: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            justify-self: center;
            text-align: center;
        }

        .aligned-block:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 10px 20px rgba(247, 147, 26, 0.3);
            z-index: 10;
        }

        /* Responsive block sizing */
        @media (max-width: 1024px) {
            .aligned-block {
                max-width: 100px;
            }
        }

        @media (max-width: 768px) {
            .aligned-block {
                max-width: 80px;
                font-size: 0.85rem;
            }
        }
        .block-hash {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .current-year {
            background: linear-gradient(135deg, rgba(247, 147, 26, 0.3) 0%, rgba(255, 171, 64, 0.3) 100%);
            border: 3px solid #f7931a;
            animation: pulse 2s infinite;
            transform: scale(1.05);
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 30px rgba(247, 147, 26, 0.6); }
            50% { box-shadow: 0 0 50px rgba(247, 147, 26, 1); }
        }
        .block-height {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #888;
            font-weight: bold;
        }
        .price-trend-up {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
        }
        .price-trend-down {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-10">
            <div class="flex items-center justify-center gap-3 mb-2">
                <svg class="w-12 h-12" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="16" fill="#f7931a"/>
                    <path fill="#fff" d="M22.5 14.5c.3-2-1.2-3-3.3-3.8l.7-2.7-1.6-.4-.7 2.6c-.4-.1-.9-.2-1.3-.3l.7-2.7-1.6-.4-.7 2.7c-.3-.1-.7-.2-1-.2l-2.2-.5-.4 1.7s1.2.3 1.2.3c.6.2.8.6.7 1l-.7 3c0 0 .1 0 .2.1h-.2l-1.1 4.2c-.1.2-.3.5-.8.4 0 0-1.2-.3-1.2-.3l-.8 1.9 2.1.5c.4.1.8.2 1.2.3l-.7 2.8 1.6.4.7-2.7c.4.1.9.2 1.3.3l-.7 2.7 1.6.4.7-2.8c2.9.5 5 .3 5.9-2.3.7-2.1 0-3.3-1.5-4 1.1-.3 1.9-1 2.1-2.5zm-3.8 5.3c-.5 2.1-4.1 1-5.2.7l.9-3.7c1.2.3 4.9.9 4.3 3zm.6-5.4c-.5 1.9-3.4.9-4.4.7l.8-3.4c1 .3 4.1.7 3.6 2.7z"/>
                </svg>
                <h1 class="text-4xl font-bold">Bitcoin <span class="gold-text">Time Machine</span></h1>
            </div>
            <p class="text-gray-400 text-lg">Track Bitcoin's price on this day throughout history</p>
            <p id="currentDate" class="text-xl mt-2 gold-text font-semibold"></p>
        </header>

        <!-- Investment Calculator -->
        <div class="glass-card rounded-xl p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                Investment Calculator
            </h2>
            <div class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-48">
                    <label class="block text-gray-400 mb-2">When did you buy Bitcoin?</label>
                    <input type="date" id="purchaseDate" min="2010-07-18" max="" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white focus:border-orange-500 focus:outline-none">
                </div>
                <div class="flex-1 min-w-48">
                    <label class="block text-gray-400 mb-2">Investment Amount (USD)</label>
                    <input type="number" id="investmentAmount" value="1000" min="1" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 text-white focus:border-orange-500 focus:outline-none">
                </div>
                <button onclick="calculateReturns()" class="btc-gradient text-black font-semibold px-6 py-3 rounded-lg hover:opacity-90 transition-opacity">
                    Calculate Returns
                </button>
            </div>
            
            <!-- Results Panel -->
            <div id="resultsPanel" class="hidden mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                    <p class="text-gray-400 text-sm mb-1">Purchase Price</p>
                    <p id="purchasePrice" class="text-2xl font-bold">-</p>
                    <p id="purchaseDateDisplay" class="text-gray-500 text-xs mt-1"></p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                    <p class="text-gray-400 text-sm mb-1">Current Value</p>
                    <p id="currentValue" class="text-2xl font-bold positive">-</p>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-4 text-center">
                    <p class="text-gray-400 text-sm mb-1">Total Return</p>
                    <p id="totalReturn" class="text-2xl font-bold">-</p>
                </div>
            </div>
        </div>

        <!-- Historical Data (Hidden until calculator submission) -->
        <div id="chartWithBlocksWrapper" class="hidden">
            <!-- Bitcoin Blockchain Blocks -->
            <div class="glass-card rounded-xl p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <svg class="w-6 h-6 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                        Bitcoin Blockchain - <span id="timelineDate" class="gold-text"></span>
                    </h2>
                    <div class="text-right">
                        <p class="text-gray-400 text-xs">Today's Price</p>
                        <div id="livePrice" class="text-2xl font-bold gold-text">Loading...</div>
                    </div>
                </div>
                <div id="blocksOverlay" class="blocks-overlay">
                    <!-- Blocks will be dynamically generated and positioned here -->
                </div>
                <p id="priceSource" class="text-gray-500 text-xs text-center mt-2"></p>
            </div>

            <!-- Chart Section -->
            <div class="glass-card rounded-xl p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                </svg>
                Price on This Day Each Year
            </h2>
            <div class="relative h-80">
                <canvas id="priceChart"></canvas>
            </div>
        </div>
        </div>
        <!-- End of chartWithBlocksWrapper -->

        <!-- Data Table -->
        <div id="tableSection" class="glass-card rounded-xl p-6 hidden">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 gold-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
                Historical Data for <span id="tableDateHeader" class="gold-text"></span>
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="text-left py-3 px-4 text-gray-400 font-medium">Date</th>
                            <th class="text-right py-3 px-4 text-gray-400 font-medium">BTC/USD Price</th>
                            <th class="text-right py-3 px-4 text-gray-400 font-medium">Return Since Genesis</th>
                            <th class="text-right py-3 px-4 text-gray-400 font-medium">5-Year CAGR</th>
                            <th id="comparisonHeader" class="text-right py-3 px-4 text-gray-400 font-medium hidden">Return Since Purchase</th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody">
                        <tr><td colspan="5" class="text-center py-8 text-gray-500">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>Data sources: Historical CSV file &amp; CoinGecko API</p>
            <p class="mt-1">Bitcoin Genesis Block: January 3, 2009</p>
        </footer>
    </div>

    <script>
        // Sample historical data (fallback if CSV not available)
        // Format: MM/DD/YYYY for matching purposes
        const sampleHistoricalData = `Date,Price
01/03/2011,0.30
01/03/2012,5.27
01/03/2013,13.30
01/03/2014,770.44
01/03/2015,314.25
01/03/2016,430.01
01/03/2017,1021.75
01/03/2018,14764.20
01/03/2019,3843.52
01/03/2020,7344.88
01/03/2021,32782.02
01/03/2022,46458.12
01/03/2023,16625.08
01/03/2024,44172.22
01/03/2025,97500.00
11/23/2011,2.48
11/23/2012,11.99
11/23/2013,798.62
11/23/2014,367.13
11/23/2015,323.87
11/23/2016,740.36
11/23/2017,8112.24
11/23/2018,4346.75
11/23/2019,7178.25
11/23/2020,18353.27
11/23/2021,56287.46
11/23/2022,16589.23
11/23/2023,37420.89
11/23/2024,99588.00
11/23/2025,98827.00`;

        let historicalData = {};
        let todayData = [];
        let purchaseYearPrice = null;
        let chart = null;
        let currentPrice = null;
        let resizeTimeout = null;

        // Get today's month and day
        const today = new Date();
        const todayMonth = today.getMonth() + 1;
        const todayDay = today.getDate();
        const todayYear = today.getFullYear();

        // Display current date
        const monthNames = ["January", "February", "March", "April", "May", "June", 
                           "July", "August", "September", "October", "November", "December"];
        document.getElementById('currentDate').textContent =
            `${monthNames[todayMonth - 1]} ${todayDay}, ${todayYear}`;
        document.getElementById('tableDateHeader').textContent =
            `${monthNames[todayMonth - 1]} ${todayDay}`;
        document.getElementById('timelineDate').textContent =
            `${monthNames[todayMonth - 1]} ${todayDay}`;

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const data = {};
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const dateStr = parts[0].trim();
                    const price = parseFloat(parts[1].trim());
                    
                    if (!isNaN(price)) {
                        data[dateStr] = price;
                    }
                }
            }
            return data;
        }

        // Filter data for today's date across all years
        function filterTodayData(data) {
            const result = [];
            const todayPattern = `${todayMonth.toString().padStart(2, '0')}/${todayDay.toString().padStart(2, '0')}`;
            
            for (const [dateStr, price] of Object.entries(data)) {
                // Parse MM/DD/YYYY format
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const month = parseInt(parts[0]);
                    const day = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    
                    if (month === todayMonth && day === todayDay) {
                        result.push({ date: dateStr, year: year, price: price });
                    }
                }
            }
            
            // Sort by year ascending
            result.sort((a, b) => a.year - b.year);
            return result;
        }

        // Calculate metrics
        function calculateMetrics(data) {
            if (data.length === 0) return data;
            
            const genesisPrice = data[0].price;
            
            return data.map((item, index) => {
                // Return since genesis
                const returnSinceGenesis = ((item.price - genesisPrice) / genesisPrice) * 100;
                
                // 5-Year CAGR
                let cagr5Year = null;
                if (index >= 5) {
                    const price5YearsAgo = data[index - 5].price;
                    cagr5Year = (Math.pow(item.price / price5YearsAgo, 1/5) - 1) * 100;
                }
                
                return {
                    ...item,
                    returnSinceGenesis,
                    cagr5Year
                };
            });
        }

        // Format currency
        function formatCurrency(value) {
            if (value === null || value === undefined) return '-';
            if (value >= 1) {
                return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return '$' + value.toFixed(4);
            }
        }

        // Format percentage
        function formatPercent(value, includeSign = true) {
            if (value === null || value === undefined) return '-';
            const sign = value >= 0 ? '+' : '';
            return (includeSign ? sign : '') + value.toFixed(2) + '%';
        }

        // Populate year selector
        function populateYearSelector(data) {
            const select = document.getElementById('purchaseYear');
            select.innerHTML = '<option value="">Select a year...</option>';
            
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.year;
                option.textContent = item.year;
                select.appendChild(option);
            });
        }

        // Render table
        function renderTable(data, purchaseDate = null, purchasePrice = null) {
            const tbody = document.getElementById('priceTableBody');
            const comparisonHeader = document.getElementById('comparisonHeader');

            // Parse purchase date to get year for comparison
            let purchaseYear = null;
            if (purchaseDate) {
                const parts = purchaseDate.split('/');
                if (parts.length === 3) {
                    purchaseYear = parseInt(parts[2]);
                }
            }

            comparisonHeader.classList.toggle('hidden', !purchaseDate);

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No data available for this date</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => {
                const returnClass = item.returnSinceGenesis >= 0 ? 'positive' : 'negative';
                const cagrClass = item.cagr5Year !== null && item.cagr5Year >= 0 ? 'positive' : 'negative';

                let comparisonCell = '';
                if (purchaseDate && purchasePrice) {
                    // Show returns only for years on or after purchase year
                    if (item.year >= purchaseYear) {
                        const returnSincePurchase = ((item.price - purchasePrice) / purchasePrice) * 100;
                        const returnPurchaseClass = returnSincePurchase >= 0 ? 'positive' : 'negative';
                        comparisonCell = `<td class="text-right py-3 px-4 ${returnPurchaseClass} font-medium">${formatPercent(returnSincePurchase)}</td>`;
                    } else {
                        comparisonCell = `<td class="text-right py-3 px-4 text-gray-500">-</td>`;
                    }
                }

                return `
                    <tr class="border-b border-gray-700/50 hover:bg-white/5 transition-colors">
                        <td class="py-3 px-4">${monthNames[todayMonth - 1]} ${todayDay}, ${item.year}</td>
                        <td class="text-right py-3 px-4 font-mono font-medium gold-text">${formatCurrency(item.price)}</td>
                        <td class="text-right py-3 px-4 ${returnClass} font-medium">${formatPercent(item.returnSinceGenesis)}</td>
                        <td class="text-right py-3 px-4 ${cagrClass} font-medium">${item.cagr5Year !== null ? formatPercent(item.cagr5Year) : '-'}</td>
                        ${comparisonCell}
                    </tr>
                `;
            }).reverse().join('');
        }

        // Render chart
        function renderChart(data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            const labels = data.map(d => d.year.toString());
            const prices = data.map(d => d.price);
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'BTC Price (USD)',
                        data: prices,
                        borderColor: '#f7931a',
                        backgroundColor: 'rgba(247, 147, 26, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#f7931a',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onResize: (chart, size) => {
                        setTimeout(() => alignBlocksWithChart(), 50);
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#f7931a',
                            bodyColor: '#fff',
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af'
                            }
                        },
                        y: {
                            type: 'logarithmic',
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#9ca3af',
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return '$' + (value / 1000).toFixed(0) + 'k';
                                    }
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate a pseudo-hash based on year and price
        function generateBlockHash(year, price) {
            const hashInput = `${year}${price}`;
            let hash = '';
            for (let i = 0; i < 16; i++) {
                const charCode = hashInput.charCodeAt(i % hashInput.length);
                hash += ((charCode * (i + 1) * 997) % 16).toString(16);
            }
            return hash;
        }

        // Calculate approximate block height for a year
        function calculateBlockHeight(year) {
            // Bitcoin genesis block: Jan 3, 2009 (block 0)
            // Approximate blocks per year: 52,560 (6 blocks/hour * 24 * 365)
            const genesisYear = 2009;
            const blocksPerYear = 52560;
            const yearsSinceGenesis = year - genesisYear;
            return Math.floor(yearsSinceGenesis * blocksPerYear);
        }

        // Render timeline blocks aligned with chart
        function renderTimelineCards(data) {
            const container = document.getElementById('blocksOverlay');
            if (!container) return;

            if (data.length === 0) {
                container.innerHTML = '<div class="aligned-block glass-card rounded-lg p-4 text-center"><p class="text-gray-400 text-sm">No data available</p></div>';
                return;
            }

            // Render blocks in chronological order (matching chart x-axis)
            const blocks = data.map((item, index) => {
                const prevItem = index > 0 ? data[index - 1] : null;
                let changePercent = null;
                let changeClass = '';
                let trendClass = '';

                if (prevItem) {
                    changePercent = ((item.price - prevItem.price) / prevItem.price) * 100;
                    changeClass = changePercent >= 0 ? 'positive' : 'negative';
                    trendClass = changePercent >= 0 ? 'price-trend-up' : 'price-trend-down';
                }

                const blockHash = generateBlockHash(item.year, item.price);
                const blockHeight = calculateBlockHeight(item.year);

                return `
                    <div class="aligned-block glass-card rounded-lg p-3 ${trendClass}">
                        <div class="text-lg font-bold gold-text mb-1">${item.year}</div>
                        <div class="text-base font-semibold text-white">${formatCurrency(item.price)}</div>
                        ${changePercent !== null ? `
                            <div class="text-xs ${changeClass} mt-1">
                                ${changePercent >= 0 ? '↑' : '↓'} ${Math.abs(changePercent).toFixed(1)}%
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            container.innerHTML = blocks;
        }

        // Align blockchain blocks with chart plot points
        function alignBlocksWithChart() {
            if (!chart || !todayData || todayData.length === 0) return;

            const xScale = chart.scales.x;
            if (!xScale) return;

            const chartCanvas = document.getElementById('priceChart');
            if (!chartCanvas) return;

            const chartArea = chart.chartArea;
            if (!chartArea) return;

            // Calculate exact pixel position for each data point
            const blockPositions = [];
            for (let i = 0; i < todayData.length; i++) {
                const pixelX = xScale.getPixelForValue(i);
                blockPositions.push(pixelX);
            }

            // Create CSS Grid columns based on chart positions
            const gridColumns = [];
            let prevPosition = chartArea.left;

            for (let i = 0; i < blockPositions.length; i++) {
                const position = blockPositions[i];
                const columnWidth = position - prevPosition;
                gridColumns.push(`${columnWidth}px`);
                prevPosition = position;
            }

            // Add remaining space
            const remaining = chartArea.right - prevPosition;
            if (remaining > 0) {
                gridColumns.push(`${remaining}px`);
            }

            // Apply grid template to blocks container
            const blocksContainer = document.getElementById('blocksOverlay');
            if (blocksContainer) {
                blocksContainer.style.gridTemplateColumns = gridColumns.join(' ');

                // Position each block in its grid column
                const blockElements = blocksContainer.querySelectorAll('.aligned-block');
                blockElements.forEach((block, index) => {
                    block.style.gridColumn = index + 1;
                });
            }
        }

        // Setup window resize handler for maintaining block-chart alignment
        function setupChartResizeHandler() {
            window.addEventListener('resize', () => {
                if (resizeTimeout) {
                    clearTimeout(resizeTimeout);
                }
                resizeTimeout = setTimeout(() => {
                    if (chart) {
                        alignBlocksWithChart();
                    }
                }, 150);
            });
        }

        // Fetch current BTC price
        async function fetchCurrentPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                const data = await response.json();
                currentPrice = data.bitcoin.usd;
                document.getElementById('livePrice').textContent = formatCurrency(currentPrice);
                document.getElementById('priceSource').textContent = 'Live price from CoinGecko';

                return currentPrice;
            } catch (error) {
                console.error('Failed to fetch current price:', error);
                document.getElementById('livePrice').textContent = 'Unable to fetch';
                document.getElementById('priceSource').textContent = 'API unavailable';
                return null;
            }
        }

        // Calculate returns based on purchase date
        function calculateReturns() {
            const purchaseDateInput = document.getElementById('purchaseDate').value;
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value) || 1000;

            if (!purchaseDateInput) {
                alert('Please select a purchase date');
                return;
            }

            // Convert YYYY-MM-DD to MM/DD/YYYY format for lookup
            const dateParts = purchaseDateInput.split('-');
            const purchaseDateStr = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;

            // Look up price for the specific date
            const purchasePrice = historicalData[purchaseDateStr];
            if (!purchasePrice) {
                alert(`No price data available for ${purchaseDateStr}. Please select a different date.`);
                return;
            }

            const latestData = todayData[todayData.length - 1];
            const latestPrice = currentPrice || latestData.price;

            const btcAmount = investmentAmount / purchasePrice;
            const currentValue = btcAmount * latestPrice;
            const totalReturn = ((currentValue - investmentAmount) / investmentAmount) * 100;

            // Display in new format: "On [date] I invested [$X] to purchase [Y] BTC"
            const resultsPanel = document.getElementById('resultsPanel');
            resultsPanel.innerHTML = `
                <div class="bg-gray-800/50 rounded-lg p-6 text-center">
                    <p class="text-xl mb-4 leading-relaxed">
                        On <span class="gold-text font-bold">${purchaseDateStr}</span>
                        I invested <span class="gold-text font-bold">${formatCurrency(investmentAmount)}</span>
                        to purchase <span class="gold-text font-bold">${btcAmount.toFixed(8)} BTC</span>
                    </p>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <p class="text-gray-400 text-sm">Current Value</p>
                            <p class="text-3xl font-bold positive">${formatCurrency(currentValue)}</p>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">Total Return</p>
                            <p class="text-3xl font-bold ${totalReturn >= 0 ? 'positive' : 'negative'}">
                                ${formatPercent(totalReturn)}
                            </p>
                        </div>
                    </div>
                </div>
            `;
            resultsPanel.classList.remove('hidden');

            // CRITICAL: Show historical sections after calculator submission
            showHistoricalSections();

            // Render all views
            renderChart(todayData);
            renderTimelineCards(todayData);
            renderTable(todayData, purchaseDateStr, purchasePrice);

            // Trigger block alignment after chart renders
            setTimeout(() => alignBlocksWithChart(), 100);
        }

        // Helper functions for showing/hiding historical sections
        function hideHistoricalSections() {
            const wrapper = document.getElementById('chartWithBlocksWrapper');
            const table = document.getElementById('tableSection');
            if (wrapper) wrapper.classList.add('hidden');
            if (table) table.classList.add('hidden');
        }

        function showHistoricalSections() {
            const wrapper = document.getElementById('chartWithBlocksWrapper');
            const table = document.getElementById('tableSection');
            if (wrapper) wrapper.classList.remove('hidden');
            if (table) table.classList.remove('hidden');
        }

        // Load data from CSV file or use sample data
        async function loadData(skipRender = false) {
            let csvText = null;
            
            // Try to load the CSV file
            try {
                const response = await fetch('btc-historical-price.csv');
                if (response.ok) {
                    csvText = await response.text();
                }
            } catch (e) {
                console.log('CSV file not found, trying without extension...');
            }
            
            if (!csvText) {
                try {
                    const response = await fetch('btc-historical-price');
                    if (response.ok) {
                        csvText = await response.text();
                    }
                } catch (e) {
                    console.log('Using sample data');
                }
            }
            
            // Use sample data if file not available
            if (!csvText) {
                csvText = sampleHistoricalData;
                console.log('Using sample historical data');
            }
            
            historicalData = parseCSV(csvText);
            todayData = filterTodayData(historicalData);
            todayData = calculateMetrics(todayData);
            
            // If no data for today's date, generate sample data
            if (todayData.length === 0) {
                // Use all available data points for demonstration
                const allData = Object.entries(historicalData).map(([date, price]) => {
                    const parts = date.split('/');
                    return { date, year: parseInt(parts[2]), price };
                }).sort((a, b) => a.year - b.year);
                
                // Get unique years
                const uniqueYears = [...new Set(allData.map(d => d.year))];
                todayData = uniqueYears.map(year => {
                    const yearData = allData.find(d => d.year === year);
                    return yearData || null;
                }).filter(Boolean);
                
                todayData = calculateMetrics(todayData);
            }

            // Only render if not skipped (for initial page load, we skip rendering)
            if (!skipRender) {
                renderTimelineCards(todayData);
                renderTable(todayData);
                renderChart(todayData);
            }
        }

        // Initialize
        async function init() {
            // 1. Hide historical sections initially (calculator is landing page)
            hideHistoricalSections();

            // 2. Set max date for purchase date input to today
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('purchaseDate').setAttribute('max', todayStr);

            // 3. Load data in background (skip rendering)
            await loadData(true);

            // 4. Fetch live price in background
            await fetchCurrentPrice();

            // 5. Setup resize handler for block-chart alignment
            setupChartResizeHandler();
        }

        init();
    </script>
</body>
</html>